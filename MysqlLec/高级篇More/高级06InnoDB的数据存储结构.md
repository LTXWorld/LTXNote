# 06InnoDB的数据存储结构

## 磁盘与内存交互的基本单位：页

基本单位：即使只修改了页内的一条记录，I/O时都要传输一整个页。

页内单链表，页间双链表（无需物理相连）；**每个数据页会为存储在其中的目录生成一个目录页**。

### 页的上层结构：

<img src="./../../Pic/image-20240103155156891.png" alt="image-20240103155156891" style="zoom:50%;" />

- 一个区里面会有64个连续的页，一个段里面又会有多个区（多个区之间不要求连续）

- 段是数据库的分配单位，不同类型的数据库对象以不同的段形式存在。
- 表空间存储的是段，是一个逻辑容器。

## 页结构：

划分为7个部分：<img src="./../../Pic/image-20240103155631397.png" alt="image-20240103155631397" style="zoom:50%;" />

### 第一部分：

#### 文件头：

整体结构：<img src="./../../Pic/image-20240103161253279.png" alt="image-20240103161253279" style="zoom:50%;" />

- 文件头偏移量：**页号**
- 文件头类型：页类型
- 文件的上一个下一个*页号*
- 文件校验和：为了处理特殊情况（如同步过程）判断当前页是否正确。
- 文件头日志序列位置：也是用来校验完整性。

#### 文件尾

### 第二部分：

#### 空闲空间

#### 用户记录

#### 最大组最小记录

记录之间比较大小靠比较主键的大小。

### 第三部分：

#### 页目录

- 将所有的记录再分成几个小组， *不包括已删除的记录。*最小记录自成一组。 
- 每个组的**最后一条记录头信息中记录当前组有多少条记录**。
- 实际构造：<img src="./../../Pic/image-20240105151226099.png" alt="image-20240105151226099" style="zoom:50%;" />

#### 页面头部

存储页面的各种状态信息。  

## 行格式

修改行格式的语法：`alter table emp2 row_format=compact`

### COMPACT行格式

<img src="./../../Pic/image-20240105153838090.png" alt="image-20240105153838090" style="zoom:50%;" />

- 变长:`varchar`声明的长度10，但实际使用时用不到10（故变长）
- NULL：标记列的值是否为null（0为null，1为非空，倒序表示）
- 记录头信息：<img src="./../../Pic/image-20240103165341740.png" alt="image-20240103165341740" style="zoom:50%;" />记录是否被删除0/1（但在物理上还未真正删除）；标记非叶子结点的最小记录；当前记录类型；当前记录在本页中的位置（*会添加两条伪记录：最小最大记录*）；当前组有多少条记录；下一条**记录的偏移量**

- 记录的真实数据

### Dynamic和Compressed行格式

#### 行溢出：

三者处理行溢出的逻辑不同。

